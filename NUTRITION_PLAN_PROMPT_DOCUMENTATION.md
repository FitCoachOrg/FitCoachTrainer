# Nutrition Plan Generation - Prompt Documentation

## Overview
This document details the nutrition plan generation system that creates personalized 7-day meal plans using client data from Supabase and AI generation via OpenRouter.

## Data Sources

### Primary Table: `client`
All client data is sourced from the `client` table in Supabase with the following schema:

```sql
create table public.client (
  client_id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  cl_name text not null,
  cl_height smallint null,
  cl_weight smallint null,
  cl_phone numeric null,
  cl_pass text not null,
  cl_username text not null,
  trainer_id bigint null,
  cl_prefer_name text null,
  cl_email text null,
  cl_primary_goal text null,
  cl_target_weight smallint null,
  cl_activity_level text null,
  specific_outcome text null,
  goal_timeline text null,
  obstacles text null,
  confidence_level integer null,
  training_experience text null,
  previous_training text null,
  training_days_per_week integer null,
  training_time_per_session text null,
  training_location text null,
  available_equipment text[] null,
  injuries_limitations text null,
  focus_areas text[] null,
  eating_habits text null,
  diet_preferences text[] null,
  food_allergies text null,
  preferred_meals_per_day integer null,
  cl_age numeric null,
  cl_sex text null,
  onboarding_completed boolean null default false,
  onboarding_progress jsonb null default '{"total_steps": 19, "current_step": 0, "completed_steps": []}'::jsonb,
  sleep_hours smallint null,
  cl_stress text null,
  cl_alcohol text null,
  cl_supplements text null,
  cl_gastric_issues text null,
  motivation_style text null,
  cl_pic text null,
  wake_time time without time zone null,
  bed_time time without time zone null,
  workout_time time without time zone null,
  workout_days jsonb null,
  bf_time time without time zone null,
  lunch_time time without time zone null,
  dinner_time time without time zone null,
  snack_time time without time zone null,
  last_login timestamp without time zone null,
  last_logout timestamp without time zone null,
  last_active timestamp without time zone null,
  current_streak smallint null,
  longest_streak smallint null,
  active_session boolean null,
  "last_checkIn" timestamp with time zone null default now(),
  last_activity timestamp with time zone null,
  fcm_token text null,
  constraint client_pkey primary key (client_id)
) TABLESPACE pg_default;
```

## Client Profile Data Mapping

### Basic Information
| Prompt Field | Supabase Column | Data Type | Description |
|--------------|----------------|-----------|-------------|
| Name | `cl_name` | text | Client's full name |
| Age | `cl_age` | numeric | Client's age in years |
| Weight | `cl_weight` | smallint | Current weight in kg |
| Height | `cl_height` | smallint | Height in cm |
| Gender | `cl_sex` | text | Biological sex (male/female) |

### Goals and Targets
| Prompt Field | Supabase Column | Data Type | Description |
|--------------|----------------|-----------|-------------|
| Target Weight | `cl_target_weight` | smallint | Target weight in kg |
| Primary Goal | `cl_primary_goal` | text | Main fitness goal |
| Specific Outcome | `specific_outcome` | text | Specific desired outcome |
| Goal Timeline | `goal_timeline` | text | Timeline for achieving goals |
| Obstacles | `obstacles` | text | Challenges or obstacles |

### Activity and Preferences
| Prompt Field | Supabase Column | Data Type | Description |
|--------------|----------------|-----------|-------------|
| Activity Level | `cl_activity_level` | text | Activity level (sedentary, light, moderate, active, very_active) |
| Preferred Meals Per Day | `preferred_meals_per_day` | integer | Number of meals preferred per day |

### Dietary Information
| Prompt Field | Supabase Column | Data Type | Description |
|--------------|----------------|-----------|-------------|
| Dietary Preferences | `diet_preferences` | text[] | Array of dietary preferences (vegetarian, vegan, gluten-free, etc.) |
| Known Allergies | `food_allergies` | text | Food allergies and intolerances |
| Supplements | `cl_supplements` | text | Current supplements being taken |
| Gastric Issues | `cl_gastric_issues` | text | Any gastric or digestive issues |

## Nutritional Calculations

### BMR Calculation (Mifflin-St Jeor Equation)
```
BMR = (10 × weight) + (6.25 × height) - (5 × age) + (gender === 'male' ? 5 : -161)
```

### TDEE Calculation
Activity multipliers applied to BMR:
- Sedentary: 1.2
- Light: 1.375
- Moderate: 1.55
- Active: 1.725
- Very Active: 1.9

### Calorie Adjustments
- Weight Loss: TDEE - 500 calories
- Muscle Gain: TDEE + 500 calories
- Maintenance: TDEE (no adjustment)

### Macronutrient Split
- Protein: 30% of calories (4 calories per gram)
- Carbohydrates: 40% of calories (4 calories per gram)
- Fats: 30% of calories (9 calories per gram)

## Dietary Restrictions Processing

### Supported Dietary Preferences
The system automatically detects and enforces the following dietary restrictions:

1. **Vegetarian**
   - Restrictions: No meat, fish, poultry, or animal products
   - Forbidden: meat, fish, poultry, beef, pork, lamb, chicken, turkey, seafood, eggs, gelatin

2. **Vegan**
   - Restrictions: No animal products whatsoever
   - Forbidden: meat, fish, poultry, dairy, eggs, honey, gelatin, any animal products

3. **Pescatarian**
   - Restrictions: Fish and seafood allowed, no other meat
   - Forbidden: beef, pork, lamb, chicken, turkey, other land animals

4. **Gluten-Free**
   - Restrictions: No wheat, barley, rye, or gluten-containing ingredients
   - Forbidden: wheat, barley, rye, gluten, bread, pasta, flour

5. **Dairy-Free**
   - Restrictions: No milk, cheese, yogurt, or dairy products
   - Forbidden: milk, cheese, yogurt, butter, cream, dairy

6. **Keto**
   - Restrictions: Very low carb, high fat. Max 20g net carbs per day
   - Forbidden: sugar, bread, pasta, rice, potatoes, high-carb foods

7. **Paleo**
   - Restrictions: No grains, legumes, dairy, or processed foods
   - Forbidden: grains, legumes, dairy, processed foods, sugar

### Allergy Processing
- Allergies from `food_allergies` field are added to the forbidden ingredients list
- System validates generated meal plans against forbidden ingredients

## Complete Prompt Structure

### Client Profile Section
```
Client Profile:
- Name: [cl_name]
- Age: [cl_age] years
- Weight: [cl_weight] kg
- Height: [cl_height] cm
- Gender: [cl_sex]
- Target Weight: [cl_target_weight] kg
- Primary Goal: [cl_primary_goal]
- Specific Outcome: [specific_outcome]
- Goal Timeline: [goal_timeline]
- Obstacles: [obstacles]
- Activity Level: [cl_activity_level]
- Preferred Meals Per Day: [preferred_meals_per_day]
- Dietary Preferences: [diet_preferences array joined with commas]
- Known Allergies: [food_allergies]
- Supplements: [cl_supplements]
- Gastric Issues: [cl_gastric_issues]
```

### Nutritional Targets Section
```
Daily Nutritional Targets:
- Calories: [calculated_target_calories] kcal
- Protein: [calculated_target_protein] g
- Carbohydrates: [calculated_target_carbs] g
- Fats: [calculated_target_fats] g
```

### Instructions Section
1. Create a 7-day (Monday to Sunday) meal plan
2. For each day, provide meals for breakfast, lunch, dinner, and one snack
3. For each meal, provide meal name, specific quantities, and nutritional values
4. CRITICAL: Ensure total nutritional values for each day EXACTLY match daily targets
5. Adjust quantities if initial plan doesn't meet calorific target
6. Provide actionable "Coach Tip" for each meal
7. Respect dietary preferences and allergies
8. Consider client's specific goals, obstacles, and timeline
9. Account for gastric issues and supplements
10. Ensure variety in meals throughout the week
11. Use realistic, measurable quantities
12. Consider preferred number of meals per day

### Dietary Restrictions Section (Conditional)
```
DIETARY RESTRICTIONS (MANDATORY):
[Generated restrictions based on diet_preferences]
FORBIDDEN: [Forbidden ingredients list]
```

### Output Format Section
```
Return ONLY a single, valid JSON object with structure:
{
  "nutrition_plan": [
    {
      "day": "Monday",
      "total": {"name": "Daily Total", "calories": X, "protein": X, "carbs": X, "fats": X},
      "breakfast": {"name": "Meal Name", "amount": "Specific quantities", "calories": X, "protein": X, "carbs": X, "fats": X, "coach_tip": "string"},
      "lunch": {...},
      "dinner": {...},
      "snacks": {...}
    }
    // ... repeat for all 7 days
  ]
}
```

## API Integration

### OpenRouter Configuration
- **Model**: `qwen/qwen3-8b:free`
- **Endpoint**: `https://openrouter.ai/api/v1/chat/completions`
- **Timeout**: 60 seconds
- **Authentication**: Bearer token via `VITE_OPENROUTER_API_KEY`

### Response Validation
1. **JSON Parsing**: Validates response is valid JSON
2. **Required Fields**: Checks for `choices[0].message.content`
3. **Forbidden Ingredients**: Scans response for forbidden ingredients
4. **Token Usage**: Logs token usage and generation time

## Error Handling

### Common Error Scenarios
1. **Empty Response**: OpenRouter returns empty response
2. **Invalid JSON**: Response is not valid JSON format
3. **Missing Fields**: Response missing required `choices` or `message` fields
4. **Timeout**: Request exceeds 60-second timeout
5. **API Errors**: HTTP errors from OpenRouter API
6. **Forbidden Ingredients**: Generated plan contains forbidden ingredients

### Debugging Information
The system logs:
- Prompt length and preview
- Raw API response
- Response status and headers
- Token usage and generation time
- Forbidden ingredient violations

## File Location
- **Main Logic**: `client/src/lib/ai-nutrition-plan.ts`
- **API Service**: `client/src/lib/open-router-service.ts`
- **Usage**: Called from `client/src/components/NutritionPlanSection.tsx`

## Environment Variables Required
- `VITE_OPENROUTER_API_KEY`: OpenRouter API key
- `VITE_SITE_URL`: Site URL for OpenRouter referrer (optional, defaults to localhost:8080)

## Summary
This nutrition plan generation system creates personalized 7-day meal plans by:
1. Fetching comprehensive client data from Supabase `client` table
2. Calculating nutritional targets using BMR/TDEE formulas
3. Processing dietary restrictions and allergies
4. Generating detailed prompts for AI
5. Calling OpenRouter API for meal plan generation
6. Validating responses and checking for compliance
7. Returning structured JSON meal plans with coach tips 