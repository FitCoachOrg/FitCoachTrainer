# Monthly Report Analysis Documentation

## 1. Performance Score Calculation

### **Current Implementation Analysis**

The performance score in the monthly report is **NOT calculated by a mathematical formula** - it's **generated by the AI (Cerebras LLM)** based on the data provided.

### **How Performance Score Works:**

1. **Data Collection**: Raw data is collected from Supabase tables
2. **KPI Calculation**: Key Performance Indicators are calculated
3. **AI Analysis**: The LLM receives all data and generates a performance score
4. **Score Range**: 0-100 (percentage)

### **KPI Components Used by AI:**

```typescript
const kpis = {
  // Adherence Metrics (0-100%)
  workoutAdherence: calculateAdherence(workoutData, scheduleData),
  nutritionAdherence: calculateNutritionAdherence(mealData),
  overallAdherence: calculateOverallAdherence(activityData, mealData, workoutData),
  
  // Progress Metrics
  weightProgress: calculateWeightProgress(activityData), // kg change
  fitnessProgress: calculateFitnessProgress(workoutData), // avg duration
  
  // Engagement Metrics
  engagementScore: engagementData[0]?.engagement_score || 0,
  momentumScore: engagementData[0]?.momentum_3w || 0,
  
  // Consistency Metrics
  consistencyScore: calculateConsistencyScore(activityData, mealData, workoutData) // 0-100%
};
```

### **KPI Calculation Formulas:**

#### **Workout Adherence**
```typescript
workoutAdherence = (completed_workouts / scheduled_workouts) * 100
```

#### **Nutrition Adherence**
```typescript
nutritionAdherence = (days_with_meals_logged / 30) * 100
```

#### **Overall Adherence**
```typescript
overallAdherence = (activityScore + mealScore + workoutScore) / 3
```

#### **Weight Progress**
```typescript
weightProgress = first_weight - last_weight // in kg
```

#### **Consistency Score**
```typescript
consistencyScore = (activityDays + mealDays + workoutDays) / (30 * 3) * 100
```

---

## 2. Data Shared with LLM (Cerebras)

### **Complete Data Table**

| **Category** | **Data Field** | **Source Table** | **Purpose** | **Example Value** |
|--------------|----------------|------------------|-------------|-------------------|
| **Client Profile** | Name | `client.cl_name` | Personalization | "Vikas Malik" |
| | Age | `client.cl_age` | Age-appropriate recommendations | 35 |
| | Primary Goal | `client.cl_primary_goal` | Goal alignment | "Weight Loss" |
| | Current Weight | `client.cl_weight` | Progress tracking | 75.5 kg |
| | Target Weight | `client.cl_target_weight` | Goal assessment | 70.0 kg |
| | Activity Level | `client.cl_activity_level` | Intensity recommendations | "Moderate" |
| | Training Days | `client.training_days_per_week` | Schedule analysis | 4 |
| **Performance KPIs** | Workout Adherence | Calculated | Compliance assessment | 85% |
| | Nutrition Adherence | Calculated | Diet compliance | 72% |
| | Overall Adherence | Calculated | General compliance | 79% |
| | Weight Progress | `activity_info.weight` | Progress tracking | -2.5 kg |
| | Engagement Score | `client_engagement_score.engagement_score` | Motivation level | 78 |
| | Consistency Score | Calculated | Reliability assessment | 65% |
| **Activity Data** | Weight Records | `activity_info` | Progress tracking | Array of weight entries |
| | Heart Rate | `activity_info.heart_rate` | Cardiovascular health | Array of HR data |
| | Sleep Hours | `activity_info.sleep_hours` | Recovery assessment | Array of sleep data |
| | Stress Level | `activity_info.stress_level` | Wellness tracking | Array of stress data |
| **Nutrition Data** | Meal Records | `meal_info` | Diet analysis | Array of meal entries |
| | Meal Types | `meal_info.meal_type` | Eating patterns | ["breakfast", "lunch"] |
| | Calories | `meal_info.calories` | Energy intake | Array of calorie data |
| | Protein | `meal_info.protein` | Macronutrient analysis | Array of protein data |
| | Carbs | `meal_info.carbs` | Macronutrient analysis | Array of carb data |
| | Fat | `meal_info.fat` | Macronutrient analysis | Array of fat data |
| **Workout Data** | Workout Records | `workout_info` | Exercise analysis | Array of workout entries |
| | Duration | `workout_info.duration` | Intensity assessment | Array of duration data |
| | Workout Type | `workout_info.workout_type` | Exercise variety | Array of workout types |
| **Schedule Data** | Scheduled Activities | `schedule` | Compliance comparison | Array of scheduled items |
| **Target Data** | Target Values | `client_target` | Goal assessment | Array of target metrics |
| **Engagement Data** | Engagement Score | `client_engagement_score` | Motivation tracking | Current engagement level |
| | Momentum Score | `engagement_14d` | Trend analysis | 3-week momentum |
| | Adherence Score | `adherence_14d` | Compliance tracking | 14-day adherence |

### **Data Processing Pipeline**

#### **Step 1: Raw Data Collection**
```typescript
// From monthly-report-data-service.ts
const clientData = {
  clientInfo: await supabase.from('client').select('*').eq('client_id', clientId),
  activityData: await supabase.from('activity_info').select('*').gte('created_at', startDate),
  mealData: await supabase.from('meal_info').select('*').gte('created_at', startDate),
  workoutData: await supabase.from('workout_info').select('*').gte('created_at', startDate),
  scheduleData: await supabase.from('schedule').select('*').gte('created_at', startDate),
  targetData: await supabase.from('client_target').select('*').eq('client_id', clientId),
  engagementData: await supabase.from('client_engagement_score').select('*').eq('client_id', clientId)
};
```

#### **Step 2: Metrics Processing**
```typescript
// From monthly-report-metrics-processor.ts
const processedMetrics = {
  weight: { monthlyAverage: 75.2, trend: 'down', weeklyData: [...] },
  sleep: { monthlyAverage: 7.5, trend: 'stable', weeklyData: [...] },
  heartRate: { monthlyAverage: 72, trend: 'up', weeklyData: [...] }
};
```

#### **Step 3: KPI Calculation**
```typescript
// From ai-monthly-report-analysis.ts
const kpis = {
  workoutAdherence: 85, // Percentage
  nutritionAdherence: 72, // Percentage
  overallAdherence: 79, // Percentage
  weightProgress: -2.5, // kg change
  engagementScore: 78, // Raw score
  consistencyScore: 65 // Percentage
};
```

#### **Step 4: AI Prompt Construction**
```typescript
// Complete context sent to LLM
const aiContext = {
  clientProfile: { name, age, primaryGoal, currentWeight, targetWeight, ... },
  month: "2025-08",
  kpis: { workoutAdherence, nutritionAdherence, overallAdherence, ... },
  metricsAnalysis: [{ metric, currentValue, targetValue, trend, performance }],
  activitySummary: { records: 45, days: 28, metrics: ["weight", "heart_rate"] },
  nutritionSummary: { records: 84, days: 25, mealTypes: ["breakfast", "lunch", "dinner"] },
  workoutSummary: { records: 12, days: 10, totalDuration: 720 }
};
```

### **AI Prompt Structure**

The LLM receives a comprehensive prompt including:

1. **Client Profile**: Personal information and goals
2. **Performance Data**: All calculated KPIs
3. **Metrics Analysis**: Individual metric performance vs targets
4. **Activity Summary**: Data collection statistics
5. **Nutrition Summary**: Meal tracking statistics
6. **Workout Summary**: Exercise tracking statistics

### **AI Output Schema**

The LLM generates structured output including:

```typescript
{
  executiveSummary: {
    overallPerformance: "string",
    keyAchievements: ["string"],
    areasOfConcern: ["string"],
    performanceScore: number // 0-100
  },
  positiveTrends: {
    whatIsWorking: ["string"],
    strengths: ["string"],
    improvements: ["string"]
  },
  recommendations: {
    areasForImprovement: ["string"],
    specificActions: ["string"],
    priorityLevel: "high" | "medium" | "low"
  },
  planForward: {
    nextMonthGoals: ["string"],
    actionSteps: ["string"],
    expectedOutcomes: ["string"]
  },
  metricsAnalysis: {
    [metricKey]: {
      performance: "excellent" | "good" | "needs_improvement" | "poor",
      trend: "improving" | "declining" | "stable",
      insights: "string",
      recommendations: "string"
    }
  }
}
```

---

## 3. Recommendations for Improvement

### **Performance Score Enhancement**

**Current Issue**: Performance score is AI-generated without clear mathematical basis

**Recommended Solution**: Implement a weighted scoring algorithm

```typescript
// Proposed Performance Score Formula
const calculatePerformanceScore = (kpis) => {
  const weights = {
    workoutAdherence: 0.25,    // 25% weight
    nutritionAdherence: 0.25,  // 25% weight
    consistencyScore: 0.20,    // 20% weight
    engagementScore: 0.15,     // 15% weight
    weightProgress: 0.10,      // 10% weight
    momentumScore: 0.05        // 5% weight
  };
  
  const score = (
    (kpis.workoutAdherence * weights.workoutAdherence) +
    (kpis.nutritionAdherence * weights.nutritionAdherence) +
    (kpis.consistencyScore * weights.consistencyScore) +
    (kpis.engagementScore * weights.engagementScore) +
    (Math.max(0, kpis.weightProgress) * weights.weightProgress) +
    (kpis.momentumScore * weights.momentumScore)
  );
  
  return Math.round(score);
};
```

### **Data Quality Improvements**

1. **Target Validation**: Ensure all metrics have corresponding targets
2. **Data Completeness**: Add data quality scores
3. **Trend Analysis**: Improve trend calculation algorithms
4. **Benchmarking**: Add industry-standard benchmarks

### **AI Prompt Enhancement**

1. **Contextual Information**: Add more context about client history
2. **Goal Alignment**: Better alignment with client's primary goals
3. **Progress Context**: Compare with previous months
4. **Seasonal Factors**: Consider seasonal variations in recommendations

---

## 4. Summary

**Performance Score**: Currently AI-generated based on comprehensive data analysis
**Data Shared**: Complete client profile, all activity/nutrition/workout data, calculated KPIs, and target comparisons
**Purpose**: Provide personalized, actionable insights for fitness coaching

The system provides rich data to the LLM for generating comprehensive, personalized monthly reports with actionable recommendations.
